name: Alerts & Brief

on:
  workflow_dispatch: {}     # manueller Start
  schedule:                 # UTC Zeiten (decken CET/CEST ab)
    - cron: '0 5 * * 1-5'   # 06:00 CET / 07:00 CEST
    - cron: '0 6 * * 1-5'   # 07:00 CET
    - cron: '0 10 * * 1-5'  # 11:00 CET / 12:00 CEST
    - cron: '0 11 * * 1-5'  # 12:00 CET
    - cron: '0 15 * * 1-5'  # 16:00 CET / 17:00 CEST
    - cron: '0 16 * * 1-5'  # 17:00 CET

permissions:
  contents: write
  actions: read
  id-token: write

concurrency:
  group: alerts-${{ github.ref }}
  cancel-in-progress: false

jobs:
  alerts:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install deps (optional)
        run: |
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run alert engine (JSON)
        run: |
          python3 tools/run_alerts.py
          test -f data/alerts_out.json && jq . data/alerts_out.json | head -n 60 || true

      - name: Render Markdown Brief
        run: |
          python3 tools/render_alerts_md.py
          test -f docs/alerts_brief.md && head -n 60 docs/alerts_brief.md || true

      - name: Commit & push Brief + JSON
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add docs/alerts_brief.md data/alerts_out.json || true
          git commit -m "alerts: brief $(date -u +'%Y-%m-%dT%H:%M:%SZ')" || echo "nichts zu committen"
          git push || true

      - name: Upload artifact (Brief)
        uses: actions/upload-artifact@v4
        with:
          name: alerts_brief
          path: |
            docs/alerts_brief.md
            data/alerts_out.json
