name: Alerts (Mars/Venus)

on:
  workflow_dispatch: {}   # manueller Start-Button
  schedule:
    # UTC-Cron: wir decken CET & CEST ab (ein Tick mehr ist ok)
    - cron: '0 5 * * 1-5'   # 06:00 CET / 07:00 CEST
    - cron: '0 6 * * 1-5'   # 07:00 CET
    - cron: '0 10 * * 1-5'  # 11:00 CET / 12:00 CEST
    - cron: '0 11 * * 1-5'  # 12:00 CET
    - cron: '0 15 * * 1-5'  # 16:00 CET / 17:00 CEST
    - cron: '0 16 * * 1-5'  # 17:00 CET

jobs:
  run-alerts:       name: Render Markdown brief
        run: |
          python3 tools/render_alerts_md.py

      - name: Commit & push brief
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add docs/alerts_brief.md
          git commit -m "alerts: brief $(date -u +'%Y-%m-%dT%H:%M:%SZ')" || echo "nichts zu committen"
          git push
    runs-on: ubuntu-latest
    permissions:
      contents: write           # wir committen das Ergebnis ins Repo
      actions: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install requirements
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run alerts engine
        run: |
          python3 tools/run_alerts.py

      - name: Kopiere Ergebnis f√ºr Doku
        run: |
          mkdir -p docs
          cp -f data/alerts_out.json docs/alerts.json

      - name: Commit & push results
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add data/alerts_out.json docs/alerts.json
          git commit -m "alerts: update $(date -u +'%Y-%m-%dT%H:%M:%SZ')" || echo "nichts zu committen"
          git push

      - name: Upload artifact (Download in Actions)
        uses: actions/upload-artifact@v4
        with:
          name: alerts-json
          path: |
            data/alerts_out.json
            docs/alerts.json
